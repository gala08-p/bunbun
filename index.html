<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>文化祭</title>
    <meta name="description" content="文化祭" />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Kaisei+Decol&display=swap"
      rel="stylesheet"
    />
</head>
<body>
    <p class="midasi">商品一覧</p>

    <div class="pop">
      <h2>ポップコーン</h2>
    </div>

    <div class="menu">
      <div class="pops">
        <p>キャラメル</p>
        <img src="キャラメル.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="キャラメルポップコーン"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>
    </div>

    <div class="menu">
      <div class="pops">
        <p>塩</p>
        <img src="ソルト.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="塩ポップコーン"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>
    </div>

    <div class="pop">
      <h2>かき氷</h2>
    </div>

    <div class="menu">
      <div class="kakis">
        <p>ブルーハワイ</p>
        <img src="ブルーハワイ.jpg" class="pic_pan" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="ブルーハワイかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>

      <div class="pans">
        <p>いちご</p>
        <img src="イチゴ.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="いちごかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>

      <div class="pans">
        <p>コーラ</p>
        <img src="コーラ.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="コーラかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>
    </div>

    <div class="menu">
      <div class="kakis">
        <p>グレープ</p>
        <img src="グレープ.jpg" class="pic_pan" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="グレープかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>

      <div class="pans">
        <p>マンゴー</p>
        <img src="マンゴー.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="マンゴーかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>

      <div class="pans">
        <p>メロン</p>
        <img src="メロン.jpg" class="pic_pop" />
        <p>400円</p>
        <div class="quantity-container">
          <button type="button" class="quantity-btn minus-btn">−</button>
          <input
            type="number"
            min="0"
            value="0"
            max="10"
            data-name="メロンかき氷"
            data-price="400"
          />
          <button type="button" class="quantity-btn plus-btn">＋</button>
        </div>
        <button type="button" class="reset-btn">リセット</button>
      </div>
    </div>

    <button class="order-btn" onclick="confirmOrder()">注文を確認</button>

    <div class="overlay" id="overlay">
      <div class="popup" id="popup">
        <div id="popupContent"></div>
        <button class="confirm-btn" onclick="submitOrder()">確定</button>
        <button class="close-btn" onclick="closePopup()">閉じる</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "orderQuantities";
      // Google Apps ScriptのウェブアプリURL（デプロイ後に設定）
      const SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL"; // ここにウェブアプリのURLを入力

      // 初期化（保存データ復元）
      window.addEventListener("DOMContentLoaded", () => {
        console.log("ページ読み込み完了");
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          const quantities = JSON.parse(savedData);
          document.querySelectorAll('input[type="number"]').forEach((input) => {
            const name = input.dataset.name;
            if (quantities[name] !== undefined) {
              input.value = quantities[name];
            }
          });
        }
      });

      // 保存関数
      function saveToStorage() {
        console.log("ローカルストレージに保存");
        const data = {};
        document.querySelectorAll('input[type="number"]').forEach((input) => {
          data[input.dataset.name] = Number(input.value);
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      // ＋ボタン
      document.querySelectorAll(".plus-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          console.log("＋ボタンクリック");
          const input = btn.parentElement.querySelector("input");
          input.value = Math.min(10, Number(input.value) + 1);
          saveToStorage();
        });
      });

      // −ボタン
      document.querySelectorAll(".minus-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          console.log("−ボタンクリック");
          const input = btn.parentElement.querySelector("input");
          input.value = Math.max(0, Number(input.value) - 1);
          saveToStorage();
        });
      });

      // リセットボタン
      document.querySelectorAll(".reset-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          console.log("リセットボタンクリック");
          const input = btn.previousElementSibling.querySelector("input");
          input.value = 0;
          saveToStorage();
        });
      });

      // 数量入力欄の直接入力
      document.querySelectorAll('input[type="number"]').forEach((input) => {
        input.addEventListener("input", () => {
          console.log("数量入力変更");
          if (input.value < 0) input.value = 0;
          if (input.value > 10) input.value = 10;
          saveToStorage();
        });
      });

      // 注文確認
      function confirmOrder() {
        console.log("注文確認ボタンクリック");
        const items = [];
        let total = 0;
        document.querySelectorAll('input[type="number"]').forEach((input) => {
          const qty = Number(input.value);
          if (qty > 0) {
            const name = input.dataset.name;
            const price = Number(input.dataset.price);
            total += qty * price;
            items.push(`<li>${name}：${qty}個 (${qty * price}円)</li>`);
          }
        });

        const popupContent = document.getElementById("popupContent");
        if (items.length > 0) {
          popupContent.innerHTML = `
            <h3>注文内容の確認</h3>
            <ul>${items.join("")}</ul>
            <p>合計金額：<strong>${total}円</strong></p>
          `;
        } else {
          popupContent.innerHTML = `<p>注文が選択されていません。</p>`;
        }

        document.getElementById("overlay").style.display = "flex";
      }

      // スプレッドシートに送信
      async function submitOrder() {
        console.log("確定ボタンクリック");
        try {
          const orderData = {
            "キャラメルポップコーン": 0,
            "塩ポップコーン": 0,
            "ブルーハワイかき氷": 0,
            "いちごかき氷": 0,
            "コーラかき氷": 0,
            "グレープかき氷": 0,
            "マンゴーかき氷": 0,
            "メロンかき氷": 0,
            total: 0
          };

          document.querySelectorAll('input[type="number"]').forEach((input) => {
            const qty = Number(input.value);
            const name = input.dataset.name;
            const price = Number(input.dataset.price);
            orderData[name] = qty;
            orderData.total += qty * price;
          });

          if (SCRIPT_URL === "https://script.google.com/macros/s/AKfycby-V8mcV-S0dF2Y0Gr9PTlalPKVXPT_TohjQGezyIZHRenTeMGA7jzL0B_rgzo1I2E/exec") {
            throw new Error("SCRIPT_URLが設定されていません。Google Apps ScriptのウェブアプリURLを設定してください。");
          }

          console.log("スプレッドシートに送信開始", orderData);
          const response = await fetch(https://script.google.com/macros/s/AKfycby-V8mcV-S0dF2Y0Gr9PTlalPKVXPT_TohjQGezyIZHRenTeMGA7jzL0B_rgzo1I2E/exec, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData),
            mode: "cors" // CORSモード明示
          });

          const result = await response.json();
          console.log("スプレッドシート送信結果", result);

          if (result.status === "success") {
            alert("注文が正常に送信されました！");
            // 注文送信後に数量をリセット
            document.querySelectorAll('input[type="number"]').forEach((input) => {
              input.value = 0;
            });
            saveToStorage();
            closePopup();
          } else {
            alert("注文の送信に失敗しました: " + result.message);
          }
        } catch (error) {
          console.error("スプレッドシート送信エラー", error);
          alert("スプレッドシートへの送信に失敗しました: " + error.message + "\n他の機能は引き続き使用可能です。");
          // エラー時も数量リセットとポップアップ閉じるは実行
          document.querySelectorAll('input[type="number"]').forEach((input) => {
            input.value = 0;
          });
          saveToStorage();
          closePopup();
        }
      }

      // ポップアップ閉じる
      function closePopup() {
        console.log("閉じるボタンクリック");
        document.getElementById("overlay").style.display = "none";
      }
    </script>
</body>
</html>
