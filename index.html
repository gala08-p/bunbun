<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文化祭</title>
    <meta name="description" content="文化祭" />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Kaisei+Decol&display=swap"
      rel="stylesheet"
    />
</head>
<body>
    <p class="midasi">商品一覧</p>
    <div class="pop">
        <h2>ポップコーン</h2>
    </div>

    <div class="menu">
        <div class="pops">
            <p>キャラメル</p>
            <img src="キャラメル.jpg" class="pic_pop" alt="キャラメルポップコーン" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="キャラメルポップコーン"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>
    </div>

    <div class="menu">
        <div class="pops">
            <p>塩</p>
            <img src="ソルト.jpg" class="pic_pop" alt="塩ポップコーン" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="塩ポップコーン"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>
    </div>

    <div class="pop">
        <h2>かき氷</h2>
    </div>

    <div class="menu">
        <div class="kakis">
            <p>ブルーハワイ</p>
            <img src="ブルーハワイ.jpg" class="pic_pan" alt="ブルーハワイかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="ブルーハワイかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>

        <div class="pans">
            <p>いちご</p>
            <img src="イチゴ.jpg" class="pic_pop" alt="いちごかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="いちごかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>

        <div class="pans">
            <p>コーラ</p>
            <img src="コーラ.jpg" class="pic_pop" alt="コーラかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="コーラかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>
    </div>

    <div class="menu">
        <div class="kakis">
            <p>グレープ</p>
            <img src="グレープ.jpg" class="pic_pan" alt="グレープかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="グレープかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>

        <div class="pans">
            <p>マンゴー</p>
            <img src="マンゴー.jpg" class="pic_pop" alt="マンゴーかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="マンゴーかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>

        <div class="pans">
            <p>メロン</p>
            <img src="メロン.jpg" class="pic_pop" alt="メロンかき氷" />
            <p>400円</p>
            <div class="quantity-container">
                <button type="button" class="quantity-btn minus-btn">−</button>
                <input
                    type="number"
                    min="0"
                    value="0"
                    max="10"
                    data-name="メロンかき氷"
                    data-price="400"
                />
                <button type="button" class="quantity-btn plus-btn">＋</button>
            </div>
            <button type="button" class="reset-btn">リセット</button>
        </div>
    </div>

    <button class="order-btn" onclick="confirmOrder()">注文を確認</button>
    <div class="overlay" id="overlay">
        <div class="popup" id="popup">
            <div id="popupContent"></div>
            <button class="confirm-btn" onclick="submitOrder()">確定</button>
            <button class="close-btn" onclick="closePopup()">閉じる</button>
        </div>
    </div>

    <script>
        // Google Apps ScriptのWebアプリURL
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbw6Seaj02NXGzy7oJcskZPLEOiY9qIimRR44hQhQlW-kAVCW2Jajyq-j0sGDMoXTA0/exec'; // 例: https://script.google.com/macros/s/AKfyc.../exec

        // 初期化（保存データ復元）
        window.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('orderQuantities');
            if (savedData) {
                const quantities = JSON.parse(savedData);
                document.querySelectorAll('input[type="number"]').forEach((input) => {
                    const name = input.dataset.name;
                    if (quantities[name] !== undefined) {
                        input.value = quantities[name];
                    }
                });
            }
        });

        // 保存関数
        function saveToStorage() {
            const data = {};
            document.querySelectorAll('input[type="number"]').forEach((input) => {
                data[input.dataset.name] = Number(input.value);
            });
            localStorage.setItem('orderQuantities', JSON.stringify(data));
        }

        // +, -, リセットボタン
        document.querySelectorAll('.plus-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                const input = btn.parentElement.querySelector('input');
                input.value = Math.min(10, Number(input.value) + 1);
                saveToStorage();
            });
        });

        document.querySelectorAll('.minus-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                const input = btn.parentElement.querySelector('input');
                input.value = Math.max(0, Number(input.value) - 1);
                saveToStorage();
            });
        });

        document.querySelectorAll('.reset-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                const input = btn.previousElementSibling.querySelector('input');
                input.value = 0;
                saveToStorage();
            });
        });

        document.querySelectorAll('input[type="number"]').forEach((input) => {
            input.addEventListener('input', () => {
                if (input.value < 0) input.value = 0;
                if (input.value > 10) input.value = 10;
                saveToStorage();
            });
        });

        // 注文確認ポップアップ
        function confirmOrder() {
            const items = [];
            let total = 0;
            document.querySelectorAll('input[type="number"]').forEach((input) => {
                const qty = Number(input.value);
                if (qty > 0) {
                    const name = input.dataset.name;
                    const price = Number(input.dataset.price);
                    total += qty * price;
                    items.push(`<li>${name}：${qty}個 (${qty * price}円)</li>`);
                }
            });

            const popupContent = document.getElementById('popupContent');
            if (items.length > 0) {
                popupContent.innerHTML = `
                    <h3>注文内容の確認</h3>
                    <ul>${items.join('')}</ul>
                    <p>合計金額：<strong>${total}円</strong></p>
                    <p style="color: red;">※「確定」で注文を送信します</p>
                `;
            } else {
                popupContent.innerHTML = `<p>注文が選択されていません。</p>`;
            }

            document.getElementById('overlay').style.display = 'flex';
        }

        // 注文送信（Google Apps Script）
        async function submitOrder() {
            const orderData = {
                timestamp: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
                caramel_popcorn: 0,
                salty_popcorn: 0,
                blue_hawaii: 0,
                strawberry: 0,
                cola: 0,
                grape: 0,
                mango: 0,
                melon: 0,
                total: 0
            };

            let total = 0;
            document.querySelectorAll('input[type="number"]').forEach((input) => {
                const qty = Number(input.value);
                if (qty > 0) {
                    const name = input.dataset.name;
                    const price = Number(input.dataset.price);
                    total += qty * price;
                    switch (name) {
                        case 'キャラメルポップコーン': orderData.caramel_popcorn = qty; break;
                        case '塩ポップコーン': orderData.salty_popcorn = qty; break;
                        case 'ブルーハワイかき氷': orderData.blue_hawaii = qty; break;
                        case 'いちごかき氷': orderData.strawberry = qty; break;
                        case 'コーラかき氷': orderData.cola = qty; break;
                        case 'グレープかき氷': orderData.grape = qty; break;
                        case 'マンゴーかき氷': orderData.mango = qty; break;
                        case 'メロンかき氷': orderData.melon = qty; break;
                    }
                }
            });

            orderData.total = total;

            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    mode: 'no-cors'
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('注文が送信されました！');
                    closePopup();
                    document.querySelectorAll('input[type="number"]').forEach((input) => {
                        input.value = 0;
                    });
                    saveToStorage();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('送信エラー:', error.message);
                alert('注文の送信に失敗しました。');
            }
        }

        // ポップアップ閉じる
        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
        }
    </script>
</body>
</html>
